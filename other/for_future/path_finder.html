<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoJSON Path Finder Demo with MapLibre</title>
    <script src="https://bundle.run/geojson-path-finder@1.5.3"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js'></script>
</head>
<body>
    <h2>GeoJSON Path Finder with MapLibre</h2>
    <div id="map" style="width: 100%; height: 500px;"></div>
    <pre id="output"></pre>

    <script>
        // GeoJSON data
        const geoJson = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": { "name": "test" },
                    "geometry": {
                        "type": "LineString",
                        "coordinates": [
                            [ -49.2649528941512, -25.443916806235375 ],
                            [ -49.263111686616, -25.443274427873067 ],
                            [ -49.262442156603193, -25.444596967825358 ],
                            [ -49.260391720938998, -25.443790849963811 ]
                        ]
                    }
                }
            ]
        };

        let start = null;
        let end = null;
        let pathFinder = null;
        let bestPath = null;

        // Initialize MapLibre map
        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
            center: [-49.263, -25.444],
            zoom: 14
        });

        map.on('load', () => {
            // Add GeoJSON line to the map
            map.addSource('line', {
                'type': 'geojson',
                'data': geoJson
            });

            map.addLayer({
                'id': 'line-layer',
                'type': 'line',
                'source': 'line',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': '#ff0000',
                    'line-width': 4
                }
            });

            // Initialize path finder with a network built from GeoJSON lines
            pathFinder = new geojsonPathFinder(geoJson, {
                precision: 1e-5,
                weightFn: (a, b) => turf.distance(turf.point(a), turf.point(b))
            });

            // Add click event to select start and end points
            map.on('click', (e) => {
                const coords = [e.lngLat.lng, e.lngLat.lat];
                const snappedPoint = turf.nearestPointOnLine(geoJson, turf.point(coords));
                const snappedCoords = snappedPoint.geometry.coordinates;

                if (!start) {
                    start = snappedCoords;
                    addMarker(snappedCoords, 'start-marker', 'green');
                } else if (!end) {
                    end = snappedCoords;
                    addMarker(snappedCoords, 'end-marker', 'red');
                    findAndDisplayPath();
                } else {
                    // Reset if both points are already selected
                    resetPath();
                    start = snappedCoords;
                    addMarker(snappedCoords, 'start-marker', 'green');
                }
            });
        });

        // Function to add a marker to the map
        function addMarker(coords, id, color) {
            const el = document.createElement('div');
            el.className = 'marker';
            el.style.backgroundColor = color;
            el.style.width = '10px';
            el.style.height = '10px';
            el.style.borderRadius = '50%';

            new maplibregl.Marker(el).setLngLat(coords).addTo(map);
        }

        // Function to find and display the path
        function findAndDisplayPath() {
            const startPoint = { type: 'Feature', geometry: { type: 'Point', coordinates: start } };
            const endPoint = { type: 'Feature', geometry: { type: 'Point', coordinates: end } };
            bestPath = pathFinder.findPath(startPoint, endPoint);

            if (bestPath && bestPath.path.length > 0) {
                const pathGeoJson = {
                    "type": "FeatureCollection",
                    "features": [
                        {
                            "type": "Feature",
                            "geometry": {
                                "type": "LineString",
                                "coordinates": bestPath.path
                            },
                            "properties": {}
                        }
                    ]
                };

                if (map.getSource('best-path')) {
                    map.getSource('best-path').setData(pathGeoJson);
                } else {
                    map.addSource('best-path', {
                        'type': 'geojson',
                        'data': pathGeoJson
                    });

                    map.addLayer({
                        'id': 'best-path-layer',
                        'type': 'line',
                        'source': 'best-path',
                        'layout': {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        'paint': {
                            'line-color': '#0000ff',
                            'line-width': 8
                        }
                    });
                }

                // Output the result
                document.getElementById('output').textContent = JSON.stringify(bestPath, null, 2);
            } else {
                console.error("Path not found");
                document.getElementById('output').textContent = "Path not found";
            }
        }

        // Function to reset path and markers
        function resetPath() {
            start = null;
            end = null;
            bestPath = null;
            document.getElementById('output').textContent = '';
            if (map.getSource('best-path')) {
                map.removeLayer('best-path-layer');
                map.removeSource('best-path');
            }
            const markers = document.getElementsByClassName('marker');
            while (markers.length > 0) {
                markers[0].parentNode.removeChild(markers[0]);
            }
        }
    </script>
</body>
</html>
