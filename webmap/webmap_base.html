<!-- url: https://kauevestena.github.io/opensidewalkmap_beta/data/tiles/sidewalks.pmtiles -->
<html>
   <head>
      <title>OSWM Node Webmap</title>
      <meta charset="utf-8"/>
      <!-- <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.css">
         <script src="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.js"></script> -->
      <!-- maplibre-gl latest tested working version: 4.3.2 -->
      <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css' />
      <script src='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js'></script> 
      <!-- pmtiles -->
      <script src="https://unpkg.com/pmtiles@latest/dist/pmtiles.js"></script>
      <!-- legend module -->
      <link href='https://www.unpkg.com/@watergis/maplibre-gl-legend@latest/dist/maplibre-gl-legend.css' rel='stylesheet' />
      <script src="https://www.unpkg.com/@watergis/maplibre-gl-legend@latest/dist/maplibre-gl-legend.umd.js"></script>
      <style>
         body {
         margin: 0;
         }
         #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #style-changer {
            position: absolute;
            top: 10px;
            right: 60px; /* Adjusted to avoid collision with the navigation control */
            background: #fff;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.10);
            z-index: 1;
        }
        #style-selector {
            border: none;
            padding: 10px;
            border-radius: 4px;
            background-color: #fff;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
        }
        #style-selector:focus {
            outline: none;
            border: none;
        }
      </style>

        <link rel="icon" type="image/x-icon" href="https://kauevestena.github.io/opensidewalkmap/assets/favicon_homepage.png">
   </head>
   <body>
       <div id="style-changer">
           <select id="style-selector"></select>
        </div>
        <div id="map"></div>
        <script type="text/javascript">

         // Global Control Variables
         var hoveredStateId_OSWMProject = null;

        //  var map_bounds = null;
        //  var map_center = null;
        //  var map_zoom = null;

         // fetching:
        //  fetch('./default_params.json')
        //     .then((response) => response.json())
        //     .then((json) => {
        //        map_bounds = json['bounds'];
        //        map_center = json['center'];
        //        map_zoom = json['zoom'];
        //     });
         
         
         // add the PMTiles plugin to the maplibregl global.
         let protocol = new pmtiles.Protocol();
         maplibregl.addProtocol("pmtiles",protocol.tile);
                  
        //  const p = new pmtiles.PMTiles(PMTILES_URL_SIDEWALKS);
         
         // // this is so we share one instance across the JS code and the map renderer
         // protocol.add(p);
         
         // // we first fetch the header so we can get the center lon, lat of the map.
         // p.getHeader().then(h => {

            fetch('./webmap_params.json')
            .then((response) => response.json())
            .then((params) => {
                

             const map = new maplibregl.Map(
                 
                 {
                 container: 'map',
                 zoom:  params['zoom'],
                 center: params['center'],
                 style: 
                 
                 params['styles']['footway_categories'],
                 
                //  {
                //      version:8,
                //      sources: params['sources'],
                //      layers: params['layers'],
                //     //  terrain: params['terrain'],
                //     //  maxPitch: 85
                //  }
             }
         
             );

             
             // add controls
             map.addControl(new maplibregl.NavigationControl());
             map.addControl(new maplibregl.FullscreenControl());
             map.addControl(new maplibregl.ScaleControl());
         
             map.fitBounds(params['bounds']);
             // map.addControl(new LogoControl({compact: false}));
         
             // add hash
             // map.addControl(new maplibregl.Hash());
         
             // add a global attribution:
             // map.addControl(new maplibregl.AttributionControl({
             //     'customAttribution': 'data: <a href="https://openstreetmap.org">OpenStreetMap Contributors</a> + <a href="https://kauevestena.github.io/opensidewalkmap/">OSWM project by KauÃª Vestena</a>'
             // }));
         
             // add geolocation
             map.on('load', function () {
                 map.addControl(new maplibregl.GeolocateControl({
                     positionOptions: {
                     enableHighAccuracy: true
                     },
                     trackUserLocation: true
                 }));

                        
                 
         
         
                 map.on('click', 'sidewalks', (e) => {
                 // const coordinates = e.features[0].geometry.coordinates.slice();
                 const coordinates = e.lngLat.toArray();
         
                 const description = e.features[0].properties.surface;
         
                 // Ensure that if the map is zoomed out such that multiple
                 // copies of the feature are visible, the popup appears
                 // over the copy being pointed to.
                 while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                     coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                 }
         
                 // const popupLngLat = new maplibregl.LngLat(coordinates[0], coordinates[1]);
         
                 new maplibregl.Popup()
                     .setLngLat(coordinates)
                     .setHTML(description)
                     .addTo(map);
                 });
         
            function setupCursorChange(layerName) {
                map.on('mouseenter', layerName, () => {
                    map.getCanvas().style.cursor = 'pointer';
                });

                map.on('mouseleave', layerName, () => {
                    map.getCanvas().style.cursor = '';
                });
            }

            // Set up cursor change effects for multiple layers
            params['data_layers'].forEach(layer => {
                setupCursorChange(layer);
            });
         
            
             // Function to set up hover effect for a specific layer
            function setupHoverEffect(layerName, sourceName, sourceLayerName) {
                let hoveredStateId = null;

                map.on('mousemove', layerName, (e) => {
                    if (e.features.length > 0) {
                        if (hoveredStateId) {
                            map.setFeatureState(
                                {
                                    source: sourceName,
                                    sourceLayer: sourceLayerName,
                                    id: hoveredStateId
                                },
                                { hover: false }
                            );
                        }

                        hoveredStateId = e.features[0].id;
                        map.setFeatureState(
                            {
                                source: sourceName,
                                sourceLayer: sourceLayerName,
                                id: hoveredStateId
                            },
                            { hover: true }
                        );
                    }
                });

                map.on('mouseleave', layerName, () => {
                    if (hoveredStateId) {
                        map.setFeatureState(
                            {
                                source: sourceName,
                                sourceLayer: sourceLayerName,
                                id: hoveredStateId
                            },
                            { hover: false }
                        );
                    }
                    hoveredStateId = null;
                });
            }

            setupHoverEffect('crossings', 'oswm_pmtiles_crossings', 'crossings');

             const legend_control_options = {
                 showDefault: false,
                 showCheckbox: true,
                 onlyRendered: false,
                 reverseOrder: true
             };
                 map.addControl(new MaplibreLegendControl.MaplibreLegendControl({}, legend_control_options), "bottom-left");
             
             });

            // // Terrain, someday! (TODO)
            // //  map.addControl(
            // //      new maplibregl.TerrainControl({
            // //         source: 'terrainSource',
            // //         exaggeration: 1
            // //     })
            // //     );
         

        // Dynamically populate the dropdown options
        const styleSelector = document.getElementById('style-selector');
        Object.keys(params['styles']).forEach(styleKey => {
            const option = document.createElement('option');
            option.value = styleKey;
            // option.textContent = params['styles'][styleKey]['name'];
            option.label = `Style: ${params['styles'][styleKey]['name']}`; // Different label
            styleSelector.appendChild(option);
        });

        // Listen for style changes
        styleSelector.addEventListener('change', function (e) {
            const style = e.target.value;
            map.setStyle(params['styles'][style]);
        });

        // END of the big "then" statement:
         });
         
         
         
         
      </script>
   </body>
</html>